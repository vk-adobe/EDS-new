{"version":3,"file":"MiniCart.js","sources":["../../src/components/MiniCart/MiniCart.tsx","../../src/containers/MiniCart/MiniCart.tsx"],"sourcesContent":["import { FunctionComponent, VNode } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\nimport { VComponent, classes } from '@adobe/elsie/lib';\nimport { Divider } from '@adobe/elsie/components';\nimport { useText } from '@adobe/elsie/i18n';\n\nimport '@/cart/components/MiniCart/MiniCart.css';\n\nexport interface MiniCartProps extends HTMLAttributes<HTMLDivElement> {\n  emptyCart: VNode;\n  heading?: VNode;\n  products?: VNode;\n  estimatedTotal?: VNode;\n  ctas?: VNode;\n}\n\nexport const MiniCart: FunctionComponent<MiniCartProps> = ({\n  className,\n  children,\n  emptyCart,\n  heading,\n  products,\n  estimatedTotal,\n  ctas,\n  ...props\n}) => {\n  const dictionary = useText({\n    estimatedTotal: 'Cart.MiniCart.estimatedTotal',\n  });\n\n  return (\n    <div {...props} className={classes(['cart-mini-cart', className])}>\n      {/* Heading */}\n      {products && heading && (\n        <div className=\"cart-mini-cart__heading\">\n          <VComponent node={heading} className=\"cart-mini-cart__heading-text\" />\n\n          <Divider\n            variant=\"primary\"\n            className=\"cart-mini-cart__heading-divider\"\n          />\n        </div>\n      )}\n\n      {/* Content */}\n      {products ? (\n        <>\n          <div className=\"cart-mini-cart__products\">{products}</div>\n\n          <div className=\"cart-mini-cart__footer\">\n            {estimatedTotal && (\n              <div className=\"cart-mini-cart__footer__estimated-total\">\n                {dictionary.estimatedTotal}\n                <VComponent node={estimatedTotal} />\n              </div>\n            )}\n\n            {ctas && (\n              <VComponent\n                node={ctas}\n                className=\"cart-mini-cart__footer__ctas\"\n              />\n            )}\n          </div>\n        </>\n      ) : (\n        <VComponent node={emptyCart} className=\"cart-mini-cart__empty-cart\" />\n      )}\n    </div>\n  );\n};\n","import { HTMLAttributes, useEffect, useState } from 'preact/compat';\nimport { Container } from '@adobe/elsie/lib';\nimport { CartModel } from '@/cart/data/models';\nimport { getPersistedData } from '@/cart/lib/persisted-data';\nimport { events } from '@adobe/event-bus';\nimport { EmptyCart, MiniCart as MiniCartComponent } from '@/cart/components';\nimport { useText } from '@adobe/elsie/i18n';\nimport {\n  Button,\n  CartItem,\n  CartList,\n  Image,\n  Price,\n} from '@adobe/elsie/components';\nimport { updateProductsFromCart } from '@/cart/api';\nimport { publishShoppingCartViewEvent } from '@/cart/lib/acdl';\nimport { state } from '@/cart/lib/state';\n\nexport interface MiniCartProps extends HTMLAttributes<HTMLDivElement> {\n  routeProduct?: (item: CartModel['items'][0]) => string;\n  routeCart?: () => string;\n  routeCheckout?: () => string;\n  routeEmptyCartCTA?: () => string;\n}\n\nexport const MiniCart: Container<MiniCartProps, CartModel | null> = ({\n  children,\n  initialData = null,\n  routeProduct,\n  routeCart,\n  routeCheckout,\n  routeEmptyCartCTA,\n  ...props\n}) => {\n  const [data, setData] = useState<CartModel | null>(initialData);\n  const [itemsLoading, setItemLoading] = useState<Set<string>>(new Set());\n\n  const handleItemsLoading = (state: boolean, uid: string) => {\n    setItemLoading((prev) => {\n      state ? prev.add(uid) : prev.delete(uid);\n      return new Set(prev);\n    });\n  };\n\n  useEffect(() => {\n    const event = events.on(\n      'cart/data',\n      (payload) => {\n        setData(payload);\n      },\n      { eager: true }\n    );\n\n    return () => {\n      event?.off();\n    };\n  }, []);\n\n  const dictionary = useText({\n    cartLink: 'Cart.MiniCart.cartLink',\n    checkoutLink: 'Cart.MiniCart.checkoutLink',\n    discountedPrice: 'Cart.CartItem.discountedPrice',\n    heading: 'Cart.MiniCart.heading',\n    message: 'Cart.CartItem.message',\n    recipient: 'Cart.CartItem.recipient',\n    regularPrice: 'Cart.CartItem.regularPrice',\n    sender: 'Cart.CartItem.sender',\n    file: 'Cart.CartItem.file',\n    files: 'Cart.CartItem.files',\n  });\n\n  const handleItemQuantityUpdate = (uid: string, quantity: number) => {\n    handleItemsLoading(true, uid);\n\n    updateProductsFromCart([{ uid, quantity }]).finally(() => {\n      handleItemsLoading(false, uid);\n    });\n  };\n\n  // Publish shopping cart view event only once when the component is mounted and initialData is available\n  useEffect(() => {\n    if (initialData && Object.keys(initialData).length > 0) {\n      publishShoppingCartViewEvent(initialData, state.locale || 'en-US');\n    }\n  }, [initialData]);\n\n  return (\n    <MiniCartComponent\n      {...props}\n      heading={\n        <div>\n          {dictionary.heading.replace(\n            '{count}',\n            (data?.totalQuantity ?? 0).toString()\n          )}\n        </div>\n      }\n      emptyCart={<EmptyCart ctaLinkURL={routeEmptyCartCTA?.()} />}\n      estimatedTotal={\n        data?.total && (\n          <Price\n            amount={data?.total.value}\n            currency={data?.total.currency}\n            style={{ font: 'inherit' }}\n          />\n        )\n      }\n      ctas={\n        <div>\n          {routeCheckout && (\n            <Button variant=\"primary\" href={routeCheckout()}>\n              {dictionary.checkoutLink}\n            </Button>\n          )}\n          {routeCart && (\n            <Button variant=\"tertiary\" href={routeCart()}>\n              {dictionary.cartLink}\n            </Button>\n          )}\n        </div>\n      }\n      products={\n        data?.totalQuantity ?? 0 ? (\n          <CartList>\n            {data?.miniCartMaxItems?.map((item, index) => {\n              const isLoading = itemsLoading.has(item.uid);\n\n              const configurations = {\n                ...(item.selectedOptions ?? {}),\n                ...(item.recipient\n                  ? { [dictionary.recipient]: item.recipient }\n                  : {}),\n                ...(item.recipientEmail && item.recipient\n                  ? {\n                      [dictionary.recipient]: `${item.recipient} (${item.recipientEmail})`,\n                    }\n                  : {}),\n                ...(item.sender ? { [dictionary.sender]: item.sender } : {}),\n                ...(item.senderEmail && item.sender\n                  ? {\n                      [dictionary.sender]: `${item.sender} (${item.senderEmail})`,\n                    }\n                  : {}),\n                ...(item.message ? { [dictionary.message]: item.message } : {}),\n                ...(item.links && item.links.count\n                  ? item.links.count > 1\n                    ? {\n                        [dictionary.files.replace(\n                          '{count}',\n                          item.links.count.toString()\n                        )]: item.links.result,\n                      }\n                    : {\n                        [dictionary.file.replace(\n                          '{count}',\n                          item.links.count.toString()\n                        )]: item.links.result,\n                      }\n                  : {}),\n              };\n\n              return (\n                <CartItem\n                  data-testid=\"cart-item\"\n                  key={item.uid}\n                  updating={isLoading}\n                  image={\n                    routeProduct ? (\n                      <a href={routeProduct(item)}>\n                        <Image\n                          loading={index < 4 ? 'eager' : 'lazy'}\n                          src={item.image.src}\n                          alt={item.image.alt}\n                          width=\"300\"\n                          height=\"300\"\n                          params={{ width: 300 }}\n                        />\n                      </a>\n                    ) : (\n                      <Image\n                        loading={index < 4 ? 'eager' : 'lazy'}\n                        src={item.image.src}\n                        alt={item.image.alt}\n                        width=\"300\"\n                        height=\"300\"\n                        params={{ width: 300 }}\n                      />\n                    )\n                  }\n                  title={\n                    <span>\n                      {routeProduct ? (\n                        <a href={routeProduct(item)}>{item.name}</a>\n                      ) : (\n                        item.name\n                      )}\n                    </span>\n                  }\n                  sku={<span>{item.sku}</span>}\n                  configurations={\n                    Object.keys(configurations).length > 0\n                      ? configurations\n                      : undefined\n                  }\n                  quantity={item.quantity}\n                  price={\n                    <Price\n                      amount={item.regularPrice?.value}\n                      currency={item.regularPrice?.currency}\n                      weight=\"normal\"\n                    />\n                  }\n                  total={\n                    <>\n                      <Price\n                        amount={item.total.value}\n                        currency={item.total.currency}\n                        variant={item.discounted ? 'strikethrough' : 'default'}\n                        data-testid=\"regular-total\"\n                        aria-label={dictionary.regularPrice}\n                      />\n\n                      {item.discounted && (\n                        <Price\n                          amount={item.discountedTotal?.value}\n                          currency={item.discountedTotal?.currency}\n                          sale={item.discounted}\n                          data-testid=\"discount-total\"\n                          aria-label={dictionary.discountedPrice}\n                        />\n                      )}\n                    </>\n                  }\n                  onRemove={() => {\n                    handleItemQuantityUpdate(item.uid, 0);\n                  }}\n                />\n              );\n            })}\n          </CartList>\n        ) : undefined\n      }\n    />\n  );\n};\n\nMiniCart.getInitialData = async function () {\n  return getPersistedData();\n};\n"],"names":["MiniCart","className","children","emptyCart","heading","products","estimatedTotal","ctas","props","dictionary","useText","_jsxs","classes","_jsx","VComponent","node","Divider","variant","_Fragment","initialData","routeProduct","routeCart","routeCheckout","routeEmptyCartCTA","data","setData","useState","itemsLoading","setItemLoading","Set","handleItemsLoading","state","uid","prev","add","delete","useEffect","event","events","on","payload","eager","off","cartLink","checkoutLink","discountedPrice","message","recipient","regularPrice","sender","file","files","handleItemQuantityUpdate","quantity","updateProductsFromCart","finally","Object","keys","length","locale","MiniCartComponent","replace","totalQuantity","toString","EmptyCart","ctaLinkURL","total","Price","amount","value","currency","style","font","Button","href","CartList","miniCartMaxItems","map","item","index","isLoading","has","configurations","selectedOptions","recipientEmail","senderEmail","links","count","result","CartItem","updating","image","Image","loading","src","alt","width","height","params","title","name","sku","undefined","price","weight","discounted","discountedTotal","sale","onRemove","getInitialData","getPersistedData"],"mappings":"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"}