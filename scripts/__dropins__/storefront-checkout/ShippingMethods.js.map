{"version":3,"file":"ShippingMethods.js","sources":["../src/components/ShippingMethods/ShippingMethods.tsx","../src/components/ShippingMethods/ShippingMethodsSkeleton.tsx","../src/utils/shippingMethods/isEqual.ts","../src/containers/ShippingMethods/ShippingMethods.tsx"],"sourcesContent":["import { classes } from '@adobe/elsie/lib';\nimport '@/checkout/components/ShippingMethods/ShippingMethods.css';\nimport {\n  Icon,\n  IllustratedMessage,\n  Price,\n  ProgressSpinner,\n  RadioButton,\n} from '@adobe/elsie/components';\nimport { useText } from '@adobe/elsie/i18n';\nimport { Delivery } from '@adobe/elsie/icons';\nimport { Heading } from '@/checkout/components';\nimport { ShippingMethodsSkeleton } from '@/checkout/components/ShippingMethods';\nimport { FunctionComponent } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\nimport { ShippingMethod } from '@/checkout/data/models';\n\nexport interface ShippingMethodsProps extends HTMLAttributes<HTMLDivElement> {\n  isLoading?: boolean;\n  onSelectionChange?: (method: ShippingMethod) => void;\n  options?: ShippingMethod[];\n  selection?: ShippingMethod;\n}\n\nexport const ShippingMethods: FunctionComponent<ShippingMethodsProps> = ({\n  className,\n  isLoading = false,\n  onSelectionChange = () => {},\n  options,\n  selection,\n  ...props\n}) => {\n  const dictionary = useText({\n    Title: 'Checkout.ShippingMethods.title',\n    EmptyState: 'Checkout.ShippingMethods.emptyState',\n  });\n\n  if (options === undefined) return <ShippingMethodsSkeleton />;\n\n  return (\n    <div\n      {...props}\n      className={classes(['checkout-shipping-methods', className])}\n    >\n      <Heading level={3} className=\"checkout-shipping-methods__title\">\n        {dictionary.Title}\n      </Heading>\n\n      {!isLoading && options.length === 0 && (\n        <IllustratedMessage\n          icon={<Icon source={Delivery} />}\n          message={<p>{dictionary.EmptyState}</p>}\n        />\n      )}\n\n      <div className={classes(['checkout-shipping-methods__content'])}>\n        {isLoading && (\n          <ProgressSpinner className=\"checkout-shipping-methods__spinner\" />\n        )}\n\n        <div\n          className={classes([\n            'checkout-shipping-methods__options',\n            ['checkout-shipping-methods__options--loading', isLoading],\n          ])}\n        >\n          {options.map((method: ShippingMethod) => {\n            return (\n              <RadioButton\n                data-testid=\"shipping-method-radiobutton\"\n                aria-busy={isLoading}\n                id={method.value}\n                key={method.value}\n                name=\"shipping-method\"\n                className=\"checkout-shipping-methods__method\"\n                label={\n                  <>\n                    <Price\n                      amount={method.amount.value}\n                      currency={method.amount.currency}\n                    />\n                    &nbsp;\n                    <span>{method.carrier.title}</span>\n                  </>\n                }\n                description={method.title}\n                value={method.value}\n                checked={selection?.value === method.value}\n                onChange={() => onSelectionChange(method)}\n              />\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n};\n","import { FunctionComponent } from 'preact';\nimport { Skeleton, SkeletonRow } from '@adobe/elsie/components';\n\nexport const ShippingMethodsSkeleton: FunctionComponent = () => {\n  return (\n    <Skeleton data-testid=\"shipping-methods-skeleton\">\n      <SkeletonRow variant=\"heading\" size=\"small\" />\n      <SkeletonRow variant=\"empty\" size=\"small\" />\n      <SkeletonRow size=\"medium\" fullWidth={true} />\n      <SkeletonRow size=\"medium\" fullWidth={true} />\n    </Skeleton>\n  );\n};\n","import { ShippingMethod } from '@/checkout/data/models';\n\nexport const isEqual = (a: ShippingMethod, b: ShippingMethod) => {\n  return a.code === b.code && a.carrier.code === b.carrier.code;\n};\n","import {\n  estimateShippingMethods,\n  setShippingMethodsOnCart,\n} from '@/checkout/api';\nimport { ShippingMethods as ShippingMethodsList } from '@/checkout/components/ShippingMethods';\nimport { PreselectedShippingMethod } from '@/checkout/containers/Checkout';\nimport { useStore } from '@/checkout/context/store';\nimport { ShippingMethod } from '@/checkout/data/models';\nimport {\n  cartSignal,\n  estimateShippingMethodsSignal,\n  regionsSignal,\n} from '@/checkout/signals';\nimport { selectedShippingMethodSignal } from '@/checkout/signals/SelectedShippingMethodSignal';\nimport { isEqual } from '@/checkout/utils/shippingMethods';\nimport { Container } from '@adobe/elsie/lib';\nimport { HTMLAttributes, useCallback, useEffect, useMemo } from 'preact/compat';\n\nexport interface ShippingMethodsProps extends HTMLAttributes<HTMLDivElement> {\n  preSelectedMethod?: PreselectedShippingMethod;\n}\n\nfunction useShippingMethods(preselectedMethod?: PreselectedShippingMethod) {\n  const store = useStore();\n  const config = store.config;\n  const isLoadingConfig = !config;\n\n  const cart = cartSignal.value.data;\n  const isLoadingCart = cartSignal.value.pending;\n  const estimationShippingMethods = estimateShippingMethodsSignal.value.data;\n  const isLoadingEstimation = estimateShippingMethodsSignal.value.pending;\n  const localShippingSelection = selectedShippingMethodSignal.value;\n\n  const cartId = cart?.id;\n  const cartShippingAddresses = cart?.shippingAddresses;\n  const primaryAddress = cartShippingAddresses?.[0];\n  const isAbleToSetShippingMethod = !!primaryAddress;\n  const cartShippingMethods = primaryAddress?.availableShippingMethods;\n  const cartShippingSelection = primaryAddress?.selectedShippingMethod;\n\n  const shippingOptions = cartShippingMethods || estimationShippingMethods;\n\n  const setShippingMethodOnCart = useCallback(\n    (method: ShippingMethod) => {\n      if (!cartId || !isAbleToSetShippingMethod) return;\n\n      const partialMethod = {\n        method_code: method.code,\n        carrier_code: method.carrier.code,\n      };\n\n      setShippingMethodsOnCart({\n        cartId,\n        shippingMethods: [partialMethod],\n      }).catch((error) => {\n        console.error('setting shipping methods on cart failed:', error);\n      });\n    },\n    [cartId, isAbleToSetShippingMethod]\n  );\n\n  const onSelectionChange = (method: ShippingMethod) => {\n    selectedShippingMethodSignal.value = method;\n  };\n\n  /**\n   * This memo is responsible for determining the selected shipping method\n   * based on the current state of the cart and the available shipping methods.\n   */\n  const selectedShippingOption: ShippingMethod | undefined = useMemo(() => {\n    if (!shippingOptions?.length) return;\n\n    const fallbackShippingOption = shippingOptions[0];\n    const selection = localShippingSelection || cartShippingSelection;\n\n    if (!selection) {\n      const preselection = shippingOptions.find((method) => {\n        return (\n          method.carrier.code === preselectedMethod?.carrierCode &&\n          method.code === preselectedMethod?.methodCode\n        );\n      });\n\n      return preselection || fallbackShippingOption;\n    }\n\n    const isAvailable = shippingOptions.some((method) =>\n      isEqual(method, selection)\n    );\n\n    return isAvailable ? selection : fallbackShippingOption;\n  }, [\n    localShippingSelection,\n    cartShippingSelection,\n    shippingOptions,\n    preselectedMethod,\n  ]);\n\n  /**\n   * This effect is responsible for syncing the local and cart state with the current selection.\n\n   * - Initialize the local selection with the data from the cart when needed.\n   * - Initialize the local selection and sync the cart when using the first available method.\n   * - If the cart gets out of sync, update the cart with the local selection.\n   */\n  useEffect(() => {\n    if (!selectedShippingOption) return;\n\n    if (\n      !localShippingSelection ||\n      !isEqual(selectedShippingOption, localShippingSelection)\n    ) {\n      selectedShippingMethodSignal.value = selectedShippingOption;\n    }\n\n    if (\n      !cartShippingSelection ||\n      !isEqual(selectedShippingOption, cartShippingSelection)\n    ) {\n      setShippingMethodOnCart(selectedShippingOption);\n    }\n  }, [\n    selectedShippingOption,\n    localShippingSelection,\n    cartShippingSelection,\n    setShippingMethodOnCart,\n  ]);\n\n  /**\n   * This effect is responsible for triggering the shipping methods estimation.\n   *\n   * - Only triggers if there is cart data and no available shipping methods.\n   * - Builds the estimate shipping search fields using the current region data or defaults.\n   * - Calls the estimateShipping function with the cartId and search fields.\n   */\n  useEffect(() => {\n    if (!cartId || cartShippingMethods) return;\n\n    const {\n      country: regionCountry,\n      selectedRegion,\n      selectedRegionId,\n    } = regionsSignal.value;\n\n    const country = regionCountry || config?.defaultCountry;\n\n    if (country) {\n      const criteria = {\n        country_code: country,\n        region_name: selectedRegion,\n        region_id: selectedRegionId,\n      };\n\n      estimateShippingMethods({ cartId, criteria }).catch((error: any) => {\n        estimateShippingMethodsSignal.value = { pending: false, data: [] };\n        console.error('shipping methods estimation failed:', error);\n      });\n    }\n  }, [cartId, cartShippingMethods, config]);\n\n  return {\n    isLoading: isLoadingCart || isLoadingConfig || isLoadingEstimation,\n    options: shippingOptions,\n    selection: selectedShippingOption,\n    onSelectionChange,\n  };\n}\n\nexport const ShippingMethods: Container<ShippingMethodsProps> = ({\n  preSelectedMethod,\n  ...props\n}) => {\n  const { isLoading, options, selection, onSelectionChange } =\n    useShippingMethods(preSelectedMethod);\n\n  return (\n    <ShippingMethodsList\n      {...props}\n      className=\"checkout-shipping-methods\"\n      isLoading={isLoading}\n      onSelectionChange={onSelectionChange}\n      options={options}\n      selection={selection}\n    />\n  );\n};\n"],"names":["ShippingMethods","className","isLoading","onSelectionChange","options","selection","props","dictionary","useText","Title","EmptyState","undefined","_jsx","ShippingMethodsSkeleton","_jsxs","classes","children","Heading","level","length","IllustratedMessage","icon","Icon","source","Delivery","message","ProgressSpinner","map","method","RadioButton","id","value","name","label","_Fragment","Price","amount","currency","carrier","title","description","checked","onChange","Skeleton","SkeletonRow","variant","size","fullWidth","isEqual","a","b","code","useShippingMethods","preselectedMethod","config","useStore","isLoadingConfig","cart","cartSignal","data","isLoadingCart","pending","estimationShippingMethods","estimateShippingMethodsSignal","isLoadingEstimation","localShippingSelection","selectedShippingMethodSignal","cartId","cartShippingAddresses","shippingAddresses","primaryAddress","isAbleToSetShippingMethod","cartShippingMethods","availableShippingMethods","cartShippingSelection","selectedShippingMethod","shippingOptions","setShippingMethodOnCart","useCallback","partialMethod","method_code","carrier_code","setShippingMethodsOnCart","shippingMethods","catch","error","selectedShippingOption","useMemo","fallbackShippingOption","some","find","carrierCode","methodCode","useEffect","country","regionCountry","selectedRegion","selectedRegionId","regionsSignal","defaultCountry","estimateShippingMethods","criteria","country_code","region_name","region_id","preSelectedMethod","ShippingMethodsList"],"mappings":"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"}